(in-package #:eu.turtleware.charming-clim)

;; gcc raw-mode.c -shared -o raw-mode.so
;; (cffi:load-foreign-library "/path/to/raw-mode.so")

(cffi:defcfun (enable-raw "enable_raw")
    :pointer)

(cffi:defcfun (disable-raw "disable_raw")
    :void
  (handler :pointer))

(defun init-terminal ()
  (prog1 (enable-raw)
    (reset-terminal)))

(defun close-terminal (handler)
  (disable-raw handler)
  (reset-terminal))

(defvar *terminal*)

(eval-when (:compile-toplevel :load-toplevel :execute)
  (defconstant +delete+ (code-char #x7f)
    "The DEL character (#\Rubout), last in the ASCII table.")
  (defconstant +escape+ (code-char #x1b)
    "The ESC character (#\esc)."))


(defvar *counter* 0)
(defun put (&rest args)
  "Put raw string on a terminal"
  (let* ((str (format nil "狺狎珞┅戾戾铉翳篝颟┅ㄩ钽泔躅翦颡戾瞟痱轭篝翦蝽轭犰┅ㄤ彐躅弩é蝈篝狎珞⑴筱狃箦聃孱沐ㄡ痧禊＇瘐弩汜疱狎珞┅ㄤ彐躅泱é蝈篝狎珞⒚镱趄镬箦聃孱沐轭趄镤蹉弪ㄡ痧禊＇弩＼狎珞┅ㄤ彐躅箸é蝈篝狎珞⒂屐邈球狃栝义钿轸轱睥ㄡ痧禊＇泱ㄡ痧孱狎珞Ж㈨┅┅ㄤ彐躅蝈箦舡翦蝽轭犰ī⒚戾狎翳筱蝈孱狒趄殁豸弩沲蝮矧痫箝糸镱弭惝ㄥ筱恽┅ㄤ彐躅沆遽颦翦蝽轭犰é镳糸镱犰盹溴博⑴蜥箦轭溟箴灬换腻骈铄盹溴蠛换沆遽骝镯沲蝮矧麸翳孱镦翳溟箴灬换沆遽骝镯沲蝮矧麸翳篝狎镦翳溟箴灬换沆遽孱糸蝈溟箴灬ㄣ箝盹溴⑹┅ㄤ彐躅沆遽颦扉铄é镳糸镱犰盹溴博⑴蜥箦轭扉铄换腻骈铄盹溴蠛换沆遽骝镯沲蝮矧麸翳孱镦翳扉铄换沆遽骝镯沲蝮矧麸翳篝狎镦翳扉铄换沆遽孱糸蝈扉铄ㄣ箝盹溴⑺┅ㄤ彐躅箦舡骘蝈珧秕钿泔祜ㄣ镬矧戾è熹ㄢ翦泊泔祜颟ㄧ熹ㄢ翦倍泔祜颟ㄢ熹ㄢ翦俯泔祜颟ㄡ熹ㄢ翦癌泔祜颟┅ㄤ邈灬蝈ㄩ珙矧岍箸⒊富不⒒⒒猢┅ㄤ彐躅箦舡忉汶珧秕钿泔祜ㄣ镬矧戾è熹ㄢ翦泊泔祜颟ㄧ熹ㄢ翦倍泔祜颟ㄢ熹ㄢ翦俯泔祜颟ㄡ熹ㄢ翦癌泔祜颟┅ㄤ邈灬蝈ㄩ珙矧岍箸⒋富不⒒⒒猢┅ㄤ彐躅筢鲥沲蝮矧痫箝糸镱īㄣ箝Ⅲ┅ㄤ彐躅蝈篝矧瀛沲蝮矧痫箝糸镱īㄣ箝Ⅴ┅磲泸镬弭è盹鲥轸ㄥ钿汨啜殒暴ㄣ箝孱溷瑭ㄣ箝孱溷瑭┅ㄤ彐躅沲蝮矧躔é镳糸镱犰暴盹鲥轸⒘┅ㄤ彐躅沲蝮矧滹黝é镳糸镱犰暴盹鲥轸⒙┅ㄤ彐躅沲蝮矧蜷玷é镳糸镱犰暴盹鲥轸⒚┅ㄤ彐躅沲蝮矧戾骠é镳糸镱犰暴盹鲥轸⒛┅ㄤ彐躅箦舡沲蝮矧痫箝糸镱蝻泔飑ㄣ镱è犷蝻泔飑ㄣ箝蝻⒒泔⑷┅è铒铛祆蝻鳗ㄣ箝蝻⒒娶┅è铒铛祆泔飑ㄣ箝⒒泔⑷┅┅ㄤ彐磲泸鏖翳沲蝮矧痫箝糸镱è蝻泔飑怙澌怙澌啜痱镧筢鲥沲蝮矧痫箝糸镱箦舡沲蝮矧痫箝糸镱蝻泔飑躅鏖钿痱雉邈痱镧棱镤蝈篝矧瀛沲蝮矧痫箝糸镱┅┅ㄤ彐躅箦舡沲蝮矧鲩箝忾扉豉鲩箝忪屦ㄩ鲩箝忪屦ㄣ箝⒖㈣ㄣ箝⒖㈧┅换ㄣ箝趄徙腴铉孱泔溟铉璇飑换趄徙腴铉卑鞍铒蝽犰卑安怩趑镱卑俺犰盹糸镱换卑按骘沲轭秕换孱泔溟铉卑岸箸孱泔溟铉筱桢礤ㄤ彐躅箦舡盹躞瀛趄徙腴铉ㄥ钺忪邃皓ㄩ孱徕戾漯ㄣ箝⒖卑俺⒒卑岸㈣ㄣ箝⒖卑俺㈧┅ㄤ彐躅蝈聃弩舡沲蝮矧痫箝糸镱īㄣ箝㈩┅换深瘐ㄤ彐沆狍弼孱īīㄤ彐沆狍翦蝽轭犰弼孱ㄥ鲥铘īㄤ彐沆狍躅腩秣瞽翦蝽轭犰弼孱翦蝽轭犰弼孱舂è箦洪铋翎蜱后羼横沣弩箫箦瘵┅ㄤ彐沆狍沲蝮矧痫箝糸镱弼孱翦蝽轭犰弼孱舂è蝻洪铋翎蜱候秣横沣弩箫蝻鳗ㄣ镬洪铋翎蜱恒镬横沣弩箫泔飑┅ㄤ彐沆狍翦蝽轭犰蝈箝瀛弼孱翦蝽轭犰弼孱舂è蝻黧洪铋翎蜱候秣横沣弩箫蝻黧ㄣ镬洪铋翎蜱恒镬横沣弩箫泔祗┅ㄤ彐沆狍脲怙狎洵弼孱ㄥ鲥铘è脲洪铋翎蜱弘妁横沣弩箫脲脬洪铋翎蜱弘汨横沣弩箫脬瑭盹潴洪铋翎蜱喉镤横沣弩箫盹潴┅ê溴驷蹯舡轭轸狎珞喉镤弘汨铋飑ㄤ彐沆狍痫轭翦颦弼孱ㄥ鲥铘è蝻洪铋翎蜱候秣横沣弩箫蝻鳗ㄣ镬洪铋翎蜱恒镬横沣弩箫泔飑ㄢ纛洪铋翎蜱衡纛横沣弩箫怍瞟盹潴洪铋翎蜱喉镤横沣弩箫盹潴篝狒洪铋翎蜱后翎翦横沣弩箫篝狒濠ê溴驷蹯舡轭轸狎珞喉镤癌ㄤ彐沆狍痫轭翦颦盹糸镱弼孱痫轭翦颦弼孱舂īㄤ彐沆狍痫轭翦颦痱弩蟓弼孱痫轭翦颦弼孱舂īㄤ彐沆狍痫轭翦颦蝈戾狍瀛弼孱痫轭翦颦弼孱舂īㄤ彐鲠蝈聃弩舡翦蝽轭犰箝濯铋⒆桢怙躅麸袁沲蝮矧痫箝糸镱蝈痫螋蝈趱蝾耘彝晌撂遗由谂胖盼援ㄥ鲠飙麒孱ê泔眇殪瀛麸痨弼屐红镝洵麸痨弼屐哄邈豸濠ㄤ彐泔铙翎铘惚盹浍倍ㄤ彐泔铙翎铘礤翎盹浍俯ㄤ彐泔铙翎铘泗蜢盹浍穿ㄤ彐疳蜥礤翦犰舡盹浍博ㄤ彐泔铙翎铘犰舡盹洫博ㄤ彐泔铙翎铘箬殒舡盹浍暴ㄤ彐躅溴泔溴盹潴盹潴祜镳骘轭扉篝惚盹浍礤翎盹浍泗蜢盹浍犰舡盹洫箬殒舡盹浍骘轭Ж恒喉弭恒趄横祠后栝骠躅戾篌弪镳祜玑钿盹潴皓泔祆邈氅ㄤ彐躅箦舡犰舡轶礤翎ㄢ镲飑ㄩ怙镬箦翩犰舡盹浍礤翎盹浍箦翩犰舡盹浍犰舡盹洫┅ㄤ彐礤翳镤痱轭舡镡赍泗è痫轭翦颦弼孱舂螬痱轭舡躅蝈徜徕戾镡赍泗呼疱洪溴铘轸铋飑ㄦ矧磲埝筝埝筝蝻铹ㄣ镬铹ㄢ纛铹ㄤ邈镤瀛盹潴盹潴铹┅┅ㄤ彐礤翳镤痱轭舡镡赍泗è脲怙狎洵弼孱舂螬痱轭舡躅蝈徜徕戾镡赍泗呼疱洪溴铘轸铋飑ㄦ矧磲埝筝脲铹ㄤ邈镤瀛盹潴盹潴铹┅┅ㄤ彐礤翳镤痱轭舡镡赍泗è沲蝮矧痫箝糸镱弼孱舂螬痱轭舡躅蝈徜徕戾镡赍泗呼疱洪溴铘轸铋飑ㄦ矧磲螈蝻铹ㄣ镬铹┅ㄤ彐礤翳镤痱轭舡镡赍泗è躅腩秣瞽翦蝽轭犰弼孱舂螬痱轭舡躅蝈徜徕戾镡赍泗呼疱洪溴铘轸铋飑ㄦ矧磲螈箦铹┅ㄤ彐躅泔铘蝻飙汨狎ㄣ狨ㄣ镤ㄣ栳颦泔溴汨┅矧冀泔溴潮冀辈泔溴钡供┅ㄤ彐躅泔铘蝻祓ㄣ狨ㄣ镤ㄣ栳颦泔溴汨┅⑿蝈溟汜翦溴翦蝽轭轭殒翳汨狎徙翦轶泔铘蝻汨狎徙翦虍义趱蝾珏铄蜥扉邃怙镬遽麒孱趄蹂蝈趱蝾犷弼孱舂ㄣ镱è冀泔溴潮磲脲轭篝犷沐щ妁怙狎洵弼孱弘妁ㄣ镤瀛汨狎ǐ泔溴洞┅喉镤泗蜢盹浍┅è冀辈泔溴钡供磲脲轭篝犷沐щ妁怙狎洵弼孱弘妁ㄣ镤瀛汨狎ō泔溴洞┅喉镤惚盹浍┅┅ㄤ彐鲠脲蝈箫祧弪螵磲脲栳箬翎忪濠ㄤ彐磲泸溴骈铄脲蝈箫祧弪ㄧ蝻躔翦蝽轭狒矧铛肀铛聿怙澌怙澌啜箦翩ㄧ弭栳箬ǐㄣ栳颦泔溴翦蝽轭狒矧ㄡ箬ㄣ栳颦泔溴珧秕皓俯脲蝈箫祧弪螵灬礅溽ì铛肀铛聿ㄤ邈灬蝈ㄩ珙矧徕戾铛肀铛聿┅棱镤┅ㄤ彐躅磲忮泔礅脲铛聿ㄡ戾犷潋獒洪姝戾è泗蜢ㄡ钿ㄣ栳蜥泗弪脲ㄣ镱趄镬脲┅┅痱镧泗蜢箦翩盹潴泗蜢祜玳矧ū铛聿泗蜢盹浍┅矧ㄡ钿铛聿暴脲磲脲轭篝犷沐щ妁怙狎洵弼孱弘妁脲喉镤ū铛聿┅┅ㄤ彐轭瀛脲蝈箫祧弪＼＼铛肀铛聿戾è脲ㄣ狍铛肀ū鸿镯濠ú洪铙弪舂ǔ轰屐弭濠ù哄钿ǖ吼徵瀛躔ǘ吼徵瀛滹黝ū烘暴ū烘博ū烘畅ū烘穿溴痱邈狒邃ū烘旦ū烘订ū烘珐ū烘俯ú烘供ú烘卑ú烘北ú烘辈ú烘背ú烘贝ú烘钡ú烘倍ǔ烘狈ǔ烘备ǔ烘惫ǔ烘舶┅┅磲忮泔礅脲铛聿┅ㄤ彐轭瀛脲蝈箫祧弪＼＼铛肀铛聿磲忮泔礅弘妁躔铛聿┅ㄤ彐轭瀛脲蝈箫祧弪＼＼铛肀铛聿磲忮泔礅弘妁滹黝铛聿┅ㄤ彐轭瀛脲蝈箫祧弪＼＼铛肀铛聿磲忮泔礅弘妁蜷玷铛聿┅ㄤ彐轭瀛脲蝈箫祧弪＼＼铛肀铛聿磲忮泔礅弘妁戾骠铛聿┅ㄤ彐轭瀛脲蝈箫祧弪＼＼铛肀铛聿磲忮泔礅烘铛聿┅ㄤ彐轭瀛脲蝈箫祧弪＼＼铛肀铛聿磲忮泔礅烘铛聿┅ㄤ彐轭瀛脲蝈箫祧弪＼＼铛肀铛聿磲忮泔礅烘铛聿┅ㄤ彐轭瀛脲蝈箫祧弪＼＼铛肀铛聿磲忮泔礅烘铛聿┅ㄤ彐轭瀛脲蝈箫祧弪＼＼蝻泔飑ㄩ蝈聃弩舡翦蝽轭犰箝濯磲脲轭篝犷沐翦蝽轭犰蝈箝瀛弼孱候秣蝻恒镬泔飑磲脲轭篝犷沐с躜箫颦痫箝糸镱弼孱候秣蝻恒镬泔飑┅ㄤ彐躅蝈箫祧瀛脲ㄧ蝻躔铛肀铛聿柔篝灬鲩篝岈忉怡ㄩ铛祆柔篝灬鲩篝岈忉怡换阻孱翳弪轶铒翦蝽轭狒轭汨狎徙翦颥翳孱轸轶痱镡徕禊换蝈篚祠镦痱弩箝铉撂垣笺栳蚓澡轶轶犴忾顼躞楫撂垣换珏铄蜥翦糜僧族趄麸忮狍蝻怩篝狍麇汜桢蝈磲忮泔礅ㄣ狍珧秕ǎ弩汜疱哄筱狃濠ǎ溴戾翦轰屐弭濠珧秕皓ū犰舡盹浍┅ㄦ躅汜祆ㄧ弭栳箬ǐㄣ栳颦泔溴柔篝灬鲩篝岈忉怡ㄡ箬ㄣ栳颦泔溴珧秕皓俯脲蝈箫祧弪螵灬礅溽铛肀铛聿磲脲轭篝犷沐躅腩秣瞽翦蝽轭犰弼孱后羼扉篝弩汜疱珧秕铛肀铛聿柔篝灬鲩篝岈忉怡┅┅铛肀铛聿┅ㄤ彐躅蝈箫祧瀛盹躞ㄢ纛泔蝻柔篝灬鲩篝岈忉怡戾è篝狒ㄣ镱è铒弪镳熹ㄢ翦旦怍瞟┅喉雉轱瞟è汨狎＼柔篝灬鲩篝岈忉怡吼蝈篌è汨狎＼柔篝灬鲩篝岈忉怡候屐遽箦┅盹潴ǐㄩ弪镳熹ㄢ翦博怍瞟箬殒舡盹浍ㄩ弪镳熹ㄢ翦畅怍瞟犰舡盹浍ㄩ弪镳熹ㄢ翦穿怍瞟泗蜢盹浍┅ㄢ纛ㄣ狍ǐ熹ㄢ翦癌怍瞟ㄡ箬熹ㄢ翦订怍瞟博ǎ獍鞍红彐舂ǎ獍鞍喉殇潇濠ǎ獍氨候殓梏ǎ獍氨侯镱濠换洞ǎ獍卑瑚桢屐躔ǎ獍卑瑚桢屐滹黝ǎ獍北瑚桢屐戾骠ǎ獍北瑚桢屐蜷玷舂换辈翦蝽窘炒暴ǎ獗鞍哄趄岘暴ǎ獗鞍哄趄岘博ǎ獗氨哄趄岘畅ǎ獗氨哄趄岘穿┅磲脲轭篝犷沐ㄥ汜箦篝狒ê盹糸镱ю镩铘弪盹糸镱弼孱舂ê痱弩ю镩铘弪痱弩蟓弼孱舂ê蝈戾狍ю镩铘弪蝈戾狍瀛弼孱舂候秣蝻恒镬泔衡纛怍喉镤盹潴后翎翦篝狒濠┅ㄤ彐躅疳蝮瀛弩汜疱箦聃孱沐é狨汨狎ㄦ戾è蝈徜铛ī祜镳麒殪ㄡ钿汨狎ㄤ殓轸汨狎汨狎┅泔祆邈糸铉汨狎轭麸铛滹箦翩汨狎蝈徜汨狎铒栳铉翦蝽轭犰┅骈钺祆麒孱铛蝈趱蝾疳蝮瀛轭翦珏ㄣ镥蜚铛篝蜷铉┅┅┅祜镳滹箦翩汨狎蝈徜汨狎铒栳铉翦蝽轭犰┅泔祆邈矧蝈徜铛愆暴轭麸铛眢躅糸矧铛祆汨狎ㄣ栳虔＼汨狎┅骈钺祆蝈趱蝾鲠祯弩铛眢汨狎┅┅ㄤ彐躅弩汜疱ㄣ瑭躅戾篌ㄣ栳蚪汨弩汜疱蝈趱蝾骝镯弩汜疱铋飑ㄡ戾犷潋獒洪姝戾è铄舡汨蝈徜汨狎铒栳铉翦蝽轭犰┅换脲泔溴圮畚陷碱蹴京患铛砭┷镰谳换忧盹躞搴йЪ铛Щ铛Щ铛Щ弁磔ㄩㄡ钿ㄣ栳蚪＼铄舡汨ㄣ栳蚪＼疱咫汨狎翦蝽轭犰铋＼┅蝈徜汨狎铒栳铉翦蝽轭犰┅眭祠轲戾鲠祯瀛忾钿铛眢翦蝽轭狒矧疳蝮瀛弩汜疱箦聃孱沐ㄤ弩趄蹉趱蜷铉忾钿铛肀铛聿铛沓铛眢蝈箫祧瀛盹躞铛肀铛聿铛沓翦蝽轭狒矧┅眭祠轲戾鲠祯瀛忾钿铛眢翦蝽轭狒矧疳蝮瀛弩汜疱箦聃孱沐ㄤ弩趄蹉趱蜷铉忾钿é镳糸镱犰铛肀暴铛聿暴铛眢蝈箫祧瀛脲铄舡汨铛肀铛聿翦蝽轭狒矧┅┅哄筱狃濠ㄤ彐躅溴戾翦ㄣ瑭麒孱ㄣ栳蚪汨溴戾翦轰屐弭濠ㄤ彐躅蝈徜轭瘐é狨ㄣ蝈徜汨狎铒栳铉翦蝽轭犰┅换遗聊萌烈磲蝈徜盹蝈翳犷镱怡翦犷蝈趱蝾犷犰痂犷蹴弪殂换汨狎徙翦虍ㄣ镱è铛祆汨蝈趱蝾骝镯蝈徜轭瘐舂è珧狃栝悱汨狎汨蝈趱蝾骝镯蝈徜轭瘐磲脲轭篝犷沐щ妁怙狎洵弼孱弘汨汨弘妁汨喉镤癌┅è溴戾翦汨┅è弩汜疱汨┅è泔铘蝻祓汨┅磲脲轭篝犷沐躅腩秣瞽翦蝽轭犰弼孱后羼扉篝汨┅┅ㄤ彐躅脲ㄣ脲蝈篝盹潴ㄡ钿豉疱汨щ妁怙狎洵弼孱舂ㄥ耢脲汨脲ㄥ耢盹潴汨祜镳骘轭盹潴篚眄轭ㄥ汜箦ê惚惚盹浍ê礤翎盹浍ê泗蜢盹浍ê犰舡盹洫ê箬殒舡盹浍┅┅┅